<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title><%= client.name %> ‚Äì Detalhes</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-3xl mx-auto bg-white p-6 rounded shadow">
    <!-- Header -->
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold">Cliente: <%= client.name %></h1>
      <div class="flex gap-4">
        <form action="/client/<%= client._id %>/edit" method="POST" onsubmit="return editClient(this, '<%= client.name %>', '<%= client.phone %>')">
          <button class="text-blue-600 hover:underline text-sm">‚úèÔ∏è Editar Cliente</button>
        </form>
        <form action="/client/<%= client._id %>/delete" method="POST" onsubmit="return confirm('Tem certeza que deseja excluir este cliente?')">
          <button class="text-red-600 hover:underline text-sm">üóëÔ∏è Excluir Cliente</button>
        </form>
        <a href="/client/<%= client._id %>/historico" class="inline-flex items-center px-3 py-1.5 bg-yellow-100 text-yellow-800 text-sm font-medium rounded hover:bg-yellow-200">
          üìú Hist√≥rico
        </a>
      </div>
    </div>

    <p class="mb-6 text-gray-600">Telefone: <%= client.phone %></p>

    <!-- Novo Agendamento -->
    <h2 class="text-xl font-semibold mb-2">Novo Agendamento</h2>
    <form action="/appointment" method="POST" onsubmit="return processForm()" class="space-y-4 mb-6">
      <input type="hidden" name="clientId" value="<%= client._id %>">
      <input type="date" name="date" required class="w-full p-2 border rounded">
      <input type="time" name="time" required class="w-full p-2 border rounded">
      <input type="number" name="duration" placeholder="Dura√ß√£o (min)" required class="w-full p-2 border rounded">

      <div>
        <h3 class="font-semibold text-lg mb-2">Servi√ßos</h3>
        <div id="services" class="space-y-2"></div>
        <button type="button" onclick="addService()" class="bg-green-500 text-white px-3 py-1 rounded">
          + Adicionar Servi√ßo
        </button>
      </div>

      <div>
        <h3 class="font-semibold text-lg mb-2">Produtos</h3>
        <div id="products" class="space-y-2"></div>
        <button type="button" onclick="addProduct()" class="bg-purple-500 text-white px-3 py-1 rounded">
          + Adicionar Produto
        </button>
      </div>

      <input type="hidden" name="services" id="servicesInput">
      <input type="hidden" name="products" id="productsInput">

      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        Agendar
      </button>
    </form>

    <!-- Lista de Agendamentos -->
    <h2 class="text-xl font-semibold mb-3">Agendamentos</h2>

    <% const visible = appointments.filter(a => (a.services.length + a.products.length) > 0); %>

    <% if (!visible.length) { %>
      <p class="text-gray-500">Nenhum agendamento.</p>
    <% } else { %>
      <ul class="space-y-4">
        <% visible.forEach(a => { %>
          <li class="p-4 bg-gray-50 rounded border">
            <div class="flex justify-between items-center mb-2">
              <strong>
                <%= a.date.toLocaleDateString('pt-BR', { timeZone:'America/Sao_Paulo' }) %> √†s 
                <%= a.date.toLocaleTimeString('pt-BR', { timeZone:'America/Sao_Paulo', hour:'2-digit', minute:'2-digit', hour12:false }) %> 
                (<%= a.duration %> min)
              </strong>
              <!-- Cancelar o agendamento inteiro -->
              <form action="/appointment/<%= a._id %>/cancel" method="POST" onsubmit="return confirm('Deseja cancelar este agendamento?')">
  <button class="text-red-600 hover:underline text-sm">Cancelar Agendamento</button>
</form>


            </div>

            <!-- Servi√ßos -->
            <% if (a.services.length) { %>
              <div>
                <span class="font-semibold">Servi√ßos:</span>
                <ul class="list-disc pl-6">
                  <% a.services.forEach((s,i) => { %>
                    <li class="flex justify-between items-start">
                      <div>
                        <%= s.name %> ‚Äì R$ <%= s.price %><br>
                        <% if (s.payments && s.payments.length) { %>
                          <ul class="ml-4 text-sm text-gray-800 mt-1">
                            <% s.payments.forEach((p,j) => { %>
                              <li>
                                üíµ Pago: R$ <%= p.amount %> em 
                                <%= new Date(p.paidAt).toLocaleDateString('pt-BR') %>
                                <% if (p.description) { %><br><em>üìù <%= p.description %></em><% } %>
                                <form action="/appointment/<%= a._id %>/remove-payment/service/<%= i %>/<%= j %>" method="POST" class="inline">
                                  <button class="text-red-500 text-sm hover:underline" onclick="return confirm('Remover pagamento?')">
                                    Remover
                                  </button>
                                </form>
                              </li>
                            <% }) %>
                          </ul>
                        <% } %>
                      </div>
                      <div class="flex gap-2">
                        <form action="/appointment/<%= a._id %>/edit-service/<%= i %>" method="POST" onsubmit="return editItem(this, '<%= s.name %>', '<%= s.price %>')">
                          <button class="text-blue-600 text-sm hover:underline">‚úèÔ∏è Editar</button>
                        </form>
                        <form action="/appointment/<%= a._id %>/remove-service/<%= i %>" method="POST" onsubmit="return confirm('Excluir servi√ßo?')">
                          <button class="text-red-600 text-sm hover:underline">üóëÔ∏è Excluir</button>
                        </form>
                        <form action="/appointment/<%= a._id %>/pay-service/<%= i %>" method="POST" onsubmit="return pagarValor(this)">
                          <input type="hidden" name="amount">
                          <button class="text-green-600 text-sm hover:underline">üí∞ Pagar</button>
                        </form>
                      </div>
                    </li>
                  <% }) %>
                </ul>
              </div>
            <% } %>

            <!-- Produtos -->
            <% if (a.products.length) { %>
              <div class="mt-2">
                <span class="font-semibold">Produtos:</span>
                <ul class="list-disc pl-6">
                  <% a.products.forEach((p,i) => { %>
                    <li class="flex justify-between items-start">
                      <div>
                        <%= p.name %> ‚Äì R$ <%= p.price %><br>
                        <% if (p.payments && p.payments.length) { %>
                          <ul class="ml-4 text-sm text-gray-800 mt-1">
                            <% p.payments.forEach((pg,j) => { %>
                              <li>
                                üíµ Pago: R$ <%= pg.amount %> em 
                                <%= new Date(pg.paidAt).toLocaleDateString('pt-BR') %>
                                <% if (pg.description) { %><br><em>üìù <%= pg.description %></em><% } %>
                                <form action="/appointment/<%= a._id %>/remove-payment/product/<%= i %>/<%= j %>" method="POST" class="inline">
                                  <button class="text-red-500 text-sm hover:underline" onclick="return confirm('Remover pagamento?')">
                                    Remover
                                  </button>
                                </form>
                              </li>
                            <% }) %>
                          </ul>
                        <% } %>
                      </div>
                      <div class="flex gap-2">
                        <form action="/appointment/<%= a._id %>/edit-product/<%= i %>" method="POST" onsubmit="return editItem(this, '<%= p.name %>', '<%= p.price %>')">
                          <button class="text-blue-600 text-sm hover:underline">‚úèÔ∏è Editar</button>
                        </form>
                        <form action="/appointment/<%= a._id %>/remove-product/<%= i %>" method="POST" onsubmit="return confirm('Excluir produto?')">
                          <button class="text-red-600 text-sm hover:underline">üóëÔ∏è Excluir</button>
                        </form>
                        <form action="/appointment/<%= a._id %>/pay-product/<%= i %>" method="POST" onsubmit="return pagarValor(this)">
                          <input type="hidden" name="amount">
                          <button class="text-green-600 text-sm hover:underline">üí∞ Pagar</button>
                        </form>
                      </div>
                    </li>
                  <% }) %>
                </ul>
              </div>
            <% } %>
          </li>
        <% }) %>
      </ul>
    <% } %>

    <!-- Totais -->
    <div class="mt-6">
      <h3 class="text-lg font-semibold">Total por Servi√ßos: <span class="text-green-600">R$ <%= totalService %></span></h3>
      <h3 class="text-lg font-semibold">Total por Produtos: <span class="text-purple-600">R$ <%= totalProduct %></span></h3>
      <h3 class="text-lg font-semibold">Total Pago: <span class="text-blue-700">R$ <%= totalPaid %></span></h3>
      <h2 class="text-xl font-bold mt-2">Total Restante: <span class="text-red-600">R$ <%= (totalService + totalProduct - totalPaid) %></span></h2>
    </div>

    <a href="/" class="inline-block mt-6 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
      üö™ Voltar
    </a>
  </div>

  <script>
    function addService() {
      const c = document.getElementById('services');
      const d = document.createElement('div');
      d.className = 'flex gap-2';
      d.innerHTML = `
        <input type="text" placeholder="Nome do servi√ßo" class="p-2 border rounded w-1/2 service-name">
        <input type="number" placeholder="Pre√ßo" class="p-2 border rounded w-1/2 service-price">
      `;
      c.appendChild(d);
    }
    function addProduct() {
      const c = document.getElementById('products');
      const d = document.createElement('div');
      d.className = 'flex gap-2';
      d.innerHTML = `
        <input type="text" placeholder="Nome do produto" class="p-2 border rounded w-1/2 product-name">
        <input type="number" placeholder="Pre√ßo" class="p-2 border rounded w-1/2 product-price">
      `;
      c.appendChild(d);
    }
    function processForm() {
      const sv = [], pr = [];
      document.querySelectorAll('.service-name').forEach((el,i) => {
        const n = el.value.trim(), p = parseFloat(document.querySelectorAll('.service-price')[i].value);
        if (n && !isNaN(p)) sv.push({name:n,price:p});
      });
      document.querySelectorAll('.product-name').forEach((el,i) => {
        const n = el.value.trim(), p = parseFloat(document.querySelectorAll('.product-price')[i].value);
        if (n && !isNaN(p)) pr.push({name:n,price:p});
      });
      document.getElementById('servicesInput').value = JSON.stringify(sv);
      document.getElementById('productsInput').value = JSON.stringify(pr);
      return true;
    }

    function pagarValor(form) {
      const v = prompt('Informe o valor pago:');
      const num = parseFloat(v);
      if (!v || isNaN(num) || num <= 0) { alert('Valor inv√°lido.'); return false; }

      let m = prompt('Forma de pagamento (Pix / Dinheiro / Cart√£o):');
      if (!m) return false;
      m = m.trim().toLowerCase();
      let key;
      if (m === 'pix') key = 'Pix';
      else if (m === 'dinheiro') key = 'Dinheiro';
      else if (m === 'cart√£o' || m === 'cartao') key = 'Cart√£o';
      else { alert('Forma inv√°lida. Use Pix, Dinheiro ou Cart√£o.'); return false; }

      const desc = prompt('Descri√ß√£o (opcional):');

      form.querySelectorAll('input[name="amount"], input[name="method"], input[name="description"]')
          .forEach(i=>i.remove());

      const ia = document.createElement('input'); ia.type='hidden'; ia.name='amount'; ia.value=num; form.appendChild(ia);
      const im = document.createElement('input'); im.type='hidden'; im.name='method'; im.value=key; form.appendChild(im);
      if (desc) {
        const id = document.createElement('input'); id.type='hidden'; id.name='description'; id.value=desc; form.appendChild(id);
      }
      return true;
    }

    function editItem(form, oldName, oldPrice) {
      const n = prompt('Novo nome:', oldName);
      if (n === null) return false;
      const p = prompt('Novo pre√ßo:', oldPrice);
      if (p === null) return false;
      const i1 = document.createElement('input'); i1.type='hidden'; i1.name='name'; i1.value=n; form.appendChild(i1);
      const i2 = document.createElement('input'); i2.type='hidden'; i2.name='price'; i2.value=p; form.appendChild(i2);
      return true;
    }

    function editClient(form, oldName, oldPhone) {
      const n = prompt('Novo nome do cliente:', oldName);
      if (n === null) return false;
      const ph = prompt('Novo telefone:', oldPhone);
      if (ph === null) return false;
      const i1 = document.createElement('input'); i1.type='hidden'; i1.name='name'; i1.value=n; form.appendChild(i1);
      const i2 = document.createElement('input'); i2.type='hidden'; i2.name='phone'; i2.value=ph; form.appendChild(i2);
      return true;
    }
  </script>
</body>
</html>
