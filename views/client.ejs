<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title><%= client.name %> – Detalhes</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-3xl mx-auto bg-white p-6 rounded shadow">

    <!-- Header com Voltar -->
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center space-x-2">
        <a href="/" class="text-gray-600 hover:text-gray-800">⬅ Voltar</a>
        <h1 class="text-2xl font-bold">Cliente: <%= client.name %></h1>
      </div>
      <div class="flex gap-4">
        <form action="/client/<%= client._id %>/edit" method="POST"
              onsubmit="return editClient(this, '<%= client.name %>', '<%= client.phone %>')">
          <button class="text-blue-600 hover:underline text-sm">✏️ Editar</button>
        </form>
        <form action="/client/<%= client._id %>/delete" method="POST"
              onsubmit="return confirm('Tem certeza que deseja excluir este cliente?')">
          <button class="text-red-600 hover:underline text-sm">🗑️ Excluir</button>
        </form>
        <a href="/client/<%= client._id %>/historico"
           class="inline-flex items-center bg-yellow-100 text-yellow-800 px-3 py-1.5 rounded text-sm hover:bg-yellow-200">
          📜 Histórico
        </a>
      </div>
    </div>

    <p class="mb-6 text-gray-600">Telefone: <%= client.phone %></p>

    <!-- Novo Agendamento -->
    <h2 class="text-xl font-semibold mb-2">Novo Agendamento</h2>
    <form action="/appointment" method="POST" onsubmit="return processForm()" class="space-y-4 mb-6">
      <input type="hidden" name="clientId" value="<%= client._id %>">
      <input type="date" name="date" required class="w-full p-2 border rounded">
      <input type="time" name="time" required class="w-full p-2 border rounded">
      <input type="number" name="duration" placeholder="Duração (min)" required class="w-full p-2 border rounded">

      <div>
        <h3 class="font-semibold text-lg mb-2">Serviços</h3>
        <div id="services" class="space-y-2"></div>
        <button type="button" onclick="addService()" class="bg-green-500 text-white px-3 py-1 rounded">
          + Adicionar Serviço
        </button>
      </div>
      <!--
      <div>
        <h3 class="font-semibold text-lg mb-2">Produtos</h3>
        <div id="products" class="space-y-2"></div>
        <button type="button" onclick="addProduct()" class="bg-purple-500 text-white px-3 py-1 rounded">
          + Adicionar Produto
        </button>
      </div>  -->

      <input type="hidden" name="services" id="servicesInput">
      <input type="hidden" name="products" id="productsInput">

      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        Agendar
      </button>
    </form>

    <!-- Lista de Agendamentos -->
    <h2 class="text-xl font-semibold mb-3">Agendamentos</h2>

    <% const visible = appointments.filter(a => a.services.length + a.products.length > 0); %>
    <% if (!visible.length) { %>
      <p class="text-gray-500">Nenhum agendamento.</p>
    <% } else { %>
      <ul class="space-y-4">
        <% visible.forEach(a => {
             // pré-calcula data/hora para evitar conflito de aspas
             const isoDate = a.date.toISOString().slice(0,10);
             const timeFmt = a.date.toLocaleTimeString('pt-BR', {
               hour: '2-digit', minute: '2-digit', hour12: false
             });
        %>
          <li class="p-4 bg-gray-50 rounded border">

            <div class="flex justify-between items-center mb-2">
              <strong>
                <%= a.date.toLocaleDateString('pt-BR', { timeZone:'America/Sao_Paulo' }) %>
                às <%= timeFmt %> (<%= a.duration %> min)
              </strong>

              <!-- Editar data/hora -->
              <form action="/appointment/<%= a._id %>/edit-datetime" method="POST"
                    onsubmit='return editDateTime(this, "<%= isoDate %>", "<%= timeFmt %>")'>
                <button class="text-blue-600 text-sm hover:underline">📅✏️ Altera Data/Hora</button>
              </form>

              <!-- Cancelar agendamento -->
              <form action="/appointment/<%= a._id %>/cancel" method="POST"
                    onsubmit="return confirm('Deseja cancelar este agendamento?')">
                <button class="text-red-600 hover:underline text-sm">Cancelar</button>
              </form>
            </div>

            <!-- Serviços -->
            <% if (a.services.length) { %>
              <div>
                <span class="font-semibold">Serviços:</span>
                <ul class="list-disc pl-6">
                  <% a.services.forEach((s,i) => { %>
                    <li class="flex justify-between items-start">
                      <div>
                        <%= s.name %> – R$ <%= s.price %><br>
                        <% if (s.payments && s.payments.length) { %>
                          <ul class="ml-4 text-sm text-gray-800 mt-1">
                            <% s.payments.forEach((p,j) => { %>
                              <li>
                                💵 Pago: R$ <%= p.amount %> em 
                                <%= new Date(p.paidAt).toLocaleDateString('pt-BR') %>
                                <% if (p.description) { %><br><em>📝 <%= p.description %></em><% } %>
                                <form action="/appointment/<%= a._id %>/remove-payment/service/<%= i %>/<%= j %>"
                                      method="POST" class="inline">
                                  <button class="text-red-500 text-sm hover:underline"
                                          onclick="return confirm('Remover pagamento?')">
                                    Remover Pagamento
                                  </button>
                                </form>
                              </li>
                            <% }) %>
                          </ul>
                        <% } %>
                      </div>
                      <div class="flex gap-2">
                        <form action="/appointment/<%= a._id %>/pay-service/<%= i %>" method="POST"
                          onsubmit="return pagarValor(this)">
                      <input type="hidden" name="amount">
                      <button class="text-green-600 text-sm hover:underline">💰 Pagar</button>
                    </form>
                        <form action="/appointment/<%= a._id %>/edit-service/<%= i %>" method="POST"
                              onsubmit="return editItem(this, '<%= s.name %>', '<%= s.price %>')">
                          <button class="text-blue-600 text-sm hover:underline">✏️ Editar</button>
                        </form>
                        <form action="/appointment/<%= a._id %>/remove-service/<%= i %>" method="POST"
                              onsubmit="return confirm('Excluir serviço?')">
                          <button class="text-red-600 text-sm hover:underline">🗑️ Excluir</button>
                        </form>
                        
                      </div>
                    </li>
                  <% }) %>
                </ul>
              </div>
            <% } %>

            <!-- Produtos -->
            <% if (a.products.length) { %>
              <div class="mt-2">
                <span class="font-semibold">Produtos:</span>
                <ul class="list-disc pl-6">
                  <% a.products.forEach((p,i) => { %>
                    <li class="flex justify-between items-start">
                      <div>
                        <%= p.name %> – R$ <%= p.price %><br>
                        <% if (p.payments && p.payments.length) { %>
                          <ul class="ml-4 text-sm text-gray-800 mt-1">
                            <% p.payments.forEach((pg,j) => { %>
                              <li>
                                💵 Pago: R$ <%= pg.amount %> em 
                                <%= new Date(pg.paidAt).toLocaleDateString('pt-BR') %>
                                <% if (pg.description) { %><br><em>📝 <%= pg.description %></em><% } %>
                                <form action="/appointment/<%= a._id %>/remove-payment/product/<%= i %>/<%= j %>"
                                      method="POST" class="inline">
                                  <button class="text-red-500 text-sm hover:underline"
                                          onclick="return confirm('Remover pagamento?')">
                                    Remover
                                  </button>
                                </form>
                              </li>
                            <% }) %>
                          </ul>
                        <% } %>
                      </div>
                      <div class="flex gap-2">
                        <form action="/appointment/<%= a._id %>/edit-product/<%= i %>" method="POST"
                              onsubmit="return editItem(this, '<%= p.name %>', '<%= p.price %>')">
                          <button class="text-blue-600 text-sm hover:underline">✏️ Editar</button>
                        </form>
                        <form action="/appointment/<%= a._id %>/remove-product/<%= i %>" method="POST"
                              onsubmit="return confirm('Excluir produto?')">
                          <button class="text-red-600 text-sm hover:underline">🗑️ Excluir</button>
                        </form>
                        <form action="/appointment/<%= a._id %>/pay-product/<%= i %>" method="POST"
                              onsubmit="return pagarValor(this)">
                          <input type="hidden" name="amount">
                          <button class="text-green-600 text-sm hover:underline">💰 Pagar</button>
                        </form>
                      </div>
                    </li>
                  <% }) %>
                </ul>
              </div>
            <% } %>

          </li>
        <% }) %>
      </ul>
    <% } %>


          <!-- Produtos diretos do cliente -->
<section class="mb-6">
  <h2 class="text-xl font-semibold mb-2">Produtos do Cliente</h2>

  <!-- Formulário de Adição -->
  <form action="/client/<%= client._id %>/add-product" method="POST" class="flex gap-2 mb-4">
    <input name="name" placeholder="Nome do produto" required
           class="flex-1 p-2 border rounded" />
    <input name="price" type="number" step="0.01" placeholder="Preço" required
           class="w-28 p-2 border rounded" />
    <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
      Adionar
    </button>
  </form>

  <% if (client.products.length) { %>
    <ul class="space-y-2">
      <% client.products.forEach((p, i) => { %>
        <li class="p-0 bg-gray-50 rounded border">
          <div class="flex justify-between items-start">
            <div>
              <strong><%= p.name %></strong> – R$ <%= p.price.toFixed(2) %><br>
              <span class="text-xs text-gray-500">
                Adicionado em <%= new Date(p.addedAt).toLocaleDateString('pt-BR') %>
              </span>
            </div>
            <div class="flex flex-row space-x-6 text-sm">
                <!-- Pagar -->
                <form action="/client/<%= client._id %>/product/<%= i %>/pay" method="POST"
                  onsubmit="return pagarValor(this)">
              <button class="text-green-600 hover:underline">💰Pagar</button>
            </form>
              
              <!-- Editar -->
              <form action="/client/<%= client._id %>/product/<%= i %>/edit" method="POST"
                    onsubmit="return editItem(this,'<%= p.name %>','<%= p.price %>')">
                <button class="text-blue-600 hover:underline">✏️Editar</button>
              </form>
            
              <!-- Excluir -->
              <form action="/client/<%= client._id %>/product/<%= i %>/delete" method="POST"
                    onsubmit="return confirm('Excluir este produto?')">
                <button class="text-red-600 hover:underline">🗑️Excluir</button>
              </form>

            </div>
            
          </div>

          <!-- Pagamentos deste produto -->
          <% if (p.payments && p.payments.length) { %>
            <ul class="mt-2 ml-4 text-sm space-y-4">
              <% p.payments.forEach((pay, j) => { %>
                <li>
                  <div class="flex items-center flex-wrap gap-2">
                    <span>
                      R$ <%= pay.amount.toFixed(2) %> em 
                      <%= new Date(pay.paidAt).toLocaleDateString('pt-BR') %>
                      (<%= pay.method %>)
                      <% if (pay.description) { %> – <em><%= pay.description %></em><% } %>
                    </span>
                    <!-- botão de cancelar pagamento -->
                    <form action="/client/<%= client._id %>/product/<%= i %>/remove-payment/<%= j %>" method="POST"
                          onsubmit="return confirm('Remover pagamento?')">
                      <button class="text-red-500 hover:underline">⛔ Excluir pagamento</button>
                    </form>
                  </div>
                </li>
              <% }) %>
            </ul>
            
          <% } %>
        </li>
      <% }) %>
    </ul>
  <% } else { %>
    <p class="text-gray-500">Nenhum produto cadastrado para este cliente.</p>
  <% } %>
</section>

          
    

    <!-- Totais -->
<div class="mt-6 space-y-2">
  <h3 class="text-lg font-semibold">
    Total por Serviços: <span class="text-green-600">R$ <%= totalService.toFixed(2) %></span>
  </h3>
  <h3 class="text-lg font-semibold">
    Total Pago em Serviços: <span class="text-blue-700">R$ <%= totalPaidService.toFixed(2) %></span>
  </h3>
  <h3 class="text-lg font-semibold">
    Total por Produtos: <span class="text-purple-600">R$ <%= totalProduct.toFixed(2) %></span>
  </h3>
  <h3 class="text-lg font-semibold">
    Total Pago em Produtos: <span class="text-blue-700">R$ <%= totalPaidProduct.toFixed(2) %></span>
  </h3>
  <h2 class="text-xl font-bold mt-2">
    Total Restante: 
    <span class="text-red-600">
      R$ <%= (totalService + totalProduct - (totalPaidService + totalPaidProduct)).toFixed(2) %>
    </span>
  </h2>
</div>

    <a href="/" class="inline-block mt-6 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
      🚪 Voltar
    </a>
  </div>

  <script>
    function addService() {
      const c = document.getElementById('services');
      const d = document.createElement('div');
      d.className = 'flex gap-2';
      d.innerHTML = `
        <input type="text" placeholder="Nome do serviço" class="p-2 border rounded w-1/2 service-name">
        <input type="number" placeholder="Preço" class="p-2 border rounded w-1/2 service-price">
      `;
      c.appendChild(d);
    }
    function addProduct() {
      const c = document.getElementById('products');
      const d = document.createElement('div');
      d.className = 'flex gap-2';
      d.innerHTML = `
        <input type="text" placeholder="Nome do produto" class="p-2 border rounded w-1/2 product-name">
        <input type="number" placeholder="Preço" class="p-2 border rounded w-1/2 product-price">
      `;
      c.appendChild(d);
    }
    function processForm() {
      const sv = [], pr = [];
      document.querySelectorAll('.service-name').forEach((el,i) => {
        const n = el.value.trim(), p = parseFloat(
          document.querySelectorAll('.service-price')[i].value
        );
        if (n && !isNaN(p)) sv.push({name:n,price:p});
      });
      document.querySelectorAll('.product-name').forEach((el,i) => {
        const n = el.value.trim(), p = parseFloat(
          document.querySelectorAll('.product-price')[i].value
        );
        if (n && !isNaN(p)) pr.push({name:n,price:p});
      });
      document.getElementById('servicesInput').value = JSON.stringify(sv);
      document.getElementById('productsInput').value = JSON.stringify(pr);
      return true;
    }
    function pagarValor(form) {
      const v = prompt('Informe o valor pago:');
      const num = parseFloat(v);
      if (!v || isNaN(num) || num <= 0) { alert('Valor inválido.'); return false; }
      let m = prompt('Forma de pagamento (Pix / Dinheiro / Cartão):');
      if (!m) return false;
      m = m.trim().toLowerCase();
      let key;
      if (m === 'pix') key = 'Pix';
      else if (m === 'dinheiro') key = 'Dinheiro';
      else if (m === 'cartão'| m==='cartao') key = 'Cartão';
      else { alert('Forma inválida. Use Pix, Dinheiro ou Cartão.'); return false; }
      const desc = prompt('Descrição (opcional):');
      form.querySelectorAll('input[name="amount"],input[name="method"],input[name="description"]')
          .forEach(i=>i.remove());
      const ia=document.createElement('input'); ia.type='hidden'; ia.name='amount'; ia.value=num; form.appendChild(ia);
      const im=document.createElement('input'); im.type='hidden'; im.name='method'; im.value=key; form.appendChild(im);
      if(desc){ const id=document.createElement('input');id.type='hidden';id.name='description';id.value=desc;form.appendChild(id);}
      return true;
    }
    function editItem(form, oldName, oldPrice) {
      const n = prompt('Novo nome:', oldName); if(n===null) return false;
      const p = prompt('Novo preço:', oldPrice); if(p===null) return false;
      const i1=document.createElement('input');i1.type='hidden';i1.name='name';i1.value=n;form.appendChild(i1);
      const i2=document.createElement('input');i2.type='hidden';i2.name='price';i2.value=p;form.appendChild(i2);
      return true;
    }
    function editClient(form, oldName, oldPhone) {
      const n=prompt('Novo nome do cliente:',oldName); if(n===null) return false;
      const ph=prompt('Novo telefone:',oldPhone); if(ph===null) return false;
      const i1=document.createElement('input');i1.type='hidden';i1.name='name';i1.value=n;form.appendChild(i1);
      const i2=document.createElement('input');i2.type='hidden';i2.name='phone';i2.value=ph;form.appendChild(i2);
      return true;
    }
    function editDateTime(form, oldDate, oldTime) {
      const d = prompt('Nova data (YYYY-MM-DD):', oldDate);
      if (d === null) return false;
      const t = prompt('Novo horário (HH:MM):', oldTime);
      if (t === null) return false;
      const i1 = document.createElement('input'); i1.type='hidden'; i1.name='date'; i1.value=d; form.appendChild(i1);
      const i2 = document.createElement('input'); i2.type='hidden'; i2.name='time'; i2.value=t; form.appendChild(i2);
      return true;
    }
  </script>
</body>
</html>
