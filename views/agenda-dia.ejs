<!DOCTYPE html>
<html lang="pt-BR" class="h-full" data-theme="light">
<head>
    <meta charset="UTF-8">
    <title>Agendamentos da Semana <%= (typeof org !== 'undefined') ? org.name : 'AgendaPro' %></title>    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        (function() {
            const THEMES = ["light", "medium-dark", "deep-dark"];
            const savedTheme = localStorage.getItem('theme');
            let initialTheme = 'light';

            if (savedTheme && THEMES.includes(savedTheme)) {
                initialTheme = savedTheme;
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                initialTheme = 'deep-dark';
            }
            document.documentElement.setAttribute('data-theme', initialTheme);
        })();
    </script>
    
    <style>
        /* ================================================= */
        /* === 1. DEFINI칂츾O DAS CORES PARA TR칅S TEMAS === */
        /* ================================================= */

        /* --- TEMA 1: LIGHT --- */
        :root, [data-theme="light"] {
            --color-gold-light: #FFD700;
            --color-gold-dark: #B8860B;
            --color-gold-accent: #DAA520;
            --color-bg-primary: #f3f4f6;   /* Fundo da P치gina */
            --color-bg-secondary: #ffffff; /* Fundo dos Cart칫es */
            --color-bg-muted: #f9fafb;     
            --color-bg-accent-light: #FFFBEB;
            --color-text-primary: #1f2937; /* Texto Principal */
            --color-text-secondary: #4b5563;
            --color-text-accent: #B8860B;
            --color-border: #e5e7eb;
        }

        /* --- TEMA 2: MEDIUM DARK --- */
        [data-theme="medium-dark"] {
            --color-gold-light: #FFD700;
            --color-gold-dark: #e0aa1f;
            --color-gold-accent: #DAA520;
            --color-bg-primary: #1f2937;   
            --color-bg-secondary: #374151; 
            --color-bg-muted: #4b5563;     
            --color-bg-accent-light: #422c01;
            --color-text-primary: #f9fafb; 
            --color-text-secondary: #d1d5db;
            --color-text-accent: #e0aa1f;
            --color-border: #4b5563;
        }

        /* --- TEMA 3: DEEP DARK --- */
        [data-theme="deep-dark"] {
            --color-gold-light: #FFD700;
            --color-gold-dark: #e0aa1f;
            --color-gold-accent: #DAA520;
            --color-bg-primary: #0a0e14;   
            --color-bg-secondary: #1f2937; 
            --color-bg-muted: #374151;
            --color-bg-accent-light: #422c01;
            --color-text-primary: #f9fafb;
            --color-text-secondary: #d1d5db;
            --color-text-accent: #e0aa1f;
            --color-border: #4b5563;
        }

        /* ================================================= */
        /* === 2. ESTILOS BASE (Mapeamento) === */
        /* ================================================= */
        
        body { 
            height: 100%; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            background-color: var(--color-bg-primary); 
            color: var(--color-text-primary);
        } 
        
        /* Mapeamento de Classes Tailwind para Vari치veis CSS */
        .bg-white, .bg-gray-800 { background-color: var(--color-bg-secondary); }
        .bg-gray-50, .bg-gray-700\/30, .bg-gray-100 { background-color: var(--color-bg-muted); } /* .bg-gray-100 usado no alerta */
        .bg-gold-light { background-color: var(--color-bg-accent-light); }
        
        .border-gray-200, .border-gray-700 { border-color: var(--color-border); }
        .border-gray-300, .border-gray-600 { border-color: var(--color-border); }
        
        .text-gray-900, .text-gray-800 { color: var(--color-text-primary); }
        .text-gray-600, .text-gray-700 { color: var(--color-text-secondary); }
        .text-gray-500 { color: var(--color-text-secondary); }
        
        /* Link Mobile */
        .mobile-nav-link { 
            color: var(--color-text-primary);
            transition: color 0.2s ease;
        }
        
        /* Cores de Status */
        .bg-yellow-50 { background-color: rgba(251, 191, 36, 0.2); }
        [data-theme^="dark"] .bg-yellow-50 { background-color: rgba(251, 191, 36, 0.1); }
        .border-yellow-200 { border-color: #fbbf24; }
        [data-theme^="dark"] .border-yellow-200 { border-color: rgba(251, 191, 36, 0.4); }

        .bg-green-50 { background-color: rgba(52, 211, 153, 0.2); }
        [data-theme^="dark"] .bg-green-50 { background-color: rgba(52, 211, 153, 0.1); }
        .border-green-200 { border-color: #6ee7b7; }
        [data-theme^="dark"] .border-green-200 { border-color: rgba(52, 211, 153, 0.4); }
        
        /* Scroll e Efeitos */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: var(--color-border); border-radius: 20px; }
        .custom-scroll:hover::-webkit-scrollbar-thumb { background-color: var(--color-gold-accent); }
        
        .text-gold { color: var(--color-text-accent); }
        .bg-gold { background-color: var(--color-gold-accent); }
        .border-gold { border-color: var(--color-gold-light); }
        .text-gradient-gold {
            background: linear-gradient(90deg, #B8860B, #FFD700, #DAA520, #FFD700, #B8860B);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 200% auto;
            animation: text-shine 4s linear infinite;
        }
        @keyframes text-shine { from { background-position: 200% center; } to { background-position: 0% center; } }
        
        .bg-shine-gold { position: relative; overflow: hidden; }
        .bg-shine-gold::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: skewX(-25deg); animation: bg-shine 5s infinite linear;
        }
        @keyframes bg-shine { 0% { left: -100%; } 100% { left: 125%; } }
        
        .appointment-card { transition: all 0.2s ease; border-left: 3px solid transparent; }
        .appointment-card:hover { border-left-color: var(--color-gold-dark); background-color: var(--color-bg-muted); }

        .weekday-badge { display: inline-flex; align-items: center; padding: 0.3rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .today-badge { background-color: #fef3c7; color: #92400e; }
        .future-badge { background-color: #dbeafe; color: #1e40af; }
        .past-badge { background-color: #f3f4f6; color: #4b5563; }

        .compact-card-body { flex-grow: 1; overflow-y: auto; min-height: 0; }
    </style>
</head>
<body class="font-sans antialiased">
    
    <header class="bg-white shadow-md border-b border-gray-200 shrink-0 h-16 flex items-center z-50">
        <div class="w-full max-w-full px-4 flex items-center justify-between">
            
            <div class="flex items-center shrink-0 mr-4">
                <h1 class="flex items-center text-gray-800 text-lg font-bold">
                   Agenda Pro
                </h1>
                <div class="h-6 w-px bg-gray-200 hidden sm:block ml-4"></div>
                <span class="text-lg font-semibold text-gray-700 flex items-center ml-4">
                    <i class="fas fa-calendar-week mr-2 text-gold"></i>
                    Agenda
                </span>
            </div>

            <nav class="hidden xl:flex items-center space-x-4 text-sm whitespace-nowrap overflow-x-auto pb-1 lg:pb-0">
                <a href="/dashboard" class="text-gray-600 hover:text-gold transition-colors">
                    <i class="fas fa-home mr-1"></i>Dash
                </a>
                <a href="/agendamentos-por-dia" class="text-gradient-gold font-semibold">
                    <i class="fas fa-calendar-alt mr-1"></i>Agenda
                </a>
                <a href="/clients" class="text-gray-600 hover:text-gold transition-colors">
                    <i class="fas fa-users mr-1"></i>Clientes
                </a>
                <a href="/admin/servicos" class="text-gray-600 hover:text-gold transition-colors">
                    <i class="fas fa-cut mr-1"></i>Servi칞os
                </a>
                <a href="/admin/equipe" class="text-gray-600 hover:text-gold transition-colors">
                    <i class="fas fa-users-cog mr-1"></i>Equipe
                </a>
                <a href="/financeiro" class="text-gray-600 hover:text-gold transition-colors">
                    <i class="fas fa-dollar-sign mr-1"></i>Financeiro
                </a>
                <a href="/balanco" class="text-gray-600 hover:text-gold transition-colors">
                    <i class="fas fa-balance-scale mr-1"></i>Balan칞o
                </a>
                <a href="/expenses" class="text-gray-600 hover:text-gold transition-colors">
                    <i class="fas fa-receipt mr-1"></i>Despesas
                </a>
                
                <div class="h-4 w-px bg-gray-300 mx-2"></div>
                
                <button id="theme-toggle-btn" class="p-2 rounded-lg hover:bg-gray-100 transition-colors text-gray-600">
                    <i id="theme-icon-sun" class="fas fa-sun"></i> <i id="theme-icon-moon" class="fas fa-moon hidden"></i> 
                </button>
                
                <a href="/logout" class="text-red-600 hover:text-red-700 transition-colors font-semibold">
                    <i class="fas fa-sign-out-alt mr-1"></i>Sair
                </a>
            </nav>

            <button id="menu-button" class="xl:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors">
                <i class="fas fa-bars text-gold"></i>
            </button>
        </div>
    </header>

    <div id="mobile-menu" class="hidden fixed inset-0 z-50 flex flex-col p-6 space-y-4 overflow-y-auto xl:hidden" style="background-color: var(--color-bg-primary);">
        <div class="flex justify-end">
            <button id="close-menu" class="text-2xl" style="color: var(--color-text-primary);"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex flex-col space-y-3 text-center">
            <a href="/dashboard" class="mobile-nav-link text-lg py-2 border-b border-gray-700 hover:text-gold">Dashboard</a>
            <a href="/agendamentos-por-dia" class="mobile-nav-link text-gold text-lg font-bold py-2 hover:text-gold">Agendamentos</a>
            <a href="/clients" class="mobile-nav-link text-lg py-2 hover:text-gold">Clientes</a>
            <a href="/admin/servicos" class="mobile-nav-link text-lg py-2 hover:text-gold">Servi칞os</a>
            <a href="/admin/equipe" class="mobile-nav-link text-lg py-2 hover:text-gold">Equipe</a>
            <a href="/financeiro" class="mobile-nav-link text-lg py-2 hover:text-gold">Financeiro</a>
            <a href="/balanco" class="mobile-nav-link text-lg py-2 hover:text-gold">Balan칞o</a>
            <a href="/expenses" class="mobile-nav-link text-lg py-2 hover:text-gold">Despesas</a>
            
            <button id="theme-toggle-btn-mobile" class="w-full flex items-center justify-center space-x-3 p-3 rounded-lg mobile-nav-link hover:bg-gray-700 hover:text-gold border border-gray-500 mt-4">
                <i id="theme-icon-sun-mobile" class="fas fa-sun w-5 text-center"></i>
                <i id="theme-icon-moon-mobile" class="fas fa-moon w-5 text-center hidden"></i>
                <span>Alternar Tema</span>
            </button>

            <a href="/logout" class="mobile-nav-link text-red-400 text-lg py-2 font-bold mt-4">Sair do Sistema</a>
        </div>
    </div>


    <main class="flex-1 p-3 overflow-hidden flex flex-col gap-3 max-w-full mx-auto w-full"
          data-default-date="<%= (typeof date !== 'undefined' && date) ? date : '' %>">

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 flex-1 min-h-0">

            <div class="lg:col-span-3 flex flex-col gap-3 overflow-y-auto custom-scroll p-1">
                
                <section class="bg-white rounded-lg shadow-xl border border-gray-200 p-4 shrink-0">
                    <h3 class="text-md font-bold text-gray-800 flex items-center mb-3">
                        <i class="fas fa-filter mr-2 text-gold"></i>
                        Buscar
                    </h3>
                    <form method="GET" action="/agendamentos-por-dia" class="flex flex-col gap-3">
                        <div>
                            <label for="date" class="block text-xs font-medium text-gray-500 mb-1">
                                Selecionar Dia
                            </label>
                            <input id="date" type="date" name="date"
                                value="<%= (typeof date !== 'undefined' && date) ? date : '' %>"
                                class="w-full p-2 text-sm border border-gray-300 bg-gray-50 rounded-lg focus:ring-1 focus:ring-gold transition-all">
                        </div>
                        <button type="submit" class="bg-gold text-white px-4 py-2 rounded-lg font-semibold text-sm hover:opacity-90 transition-opacity">
                            <i class="fas fa-search mr-2"></i> Buscar
                        </button>
                    </form>
                </section>

                <section class="bg-white rounded-lg shadow-xl border border-gray-200 p-4 flex-1">
                    <h3 class="text-md font-bold text-gray-800 flex items-center mb-3">
                        <i class="fas fa-chart-bar mr-2 text-gold"></i>
                        Resumo (Semana)
                    </h3>
                    
                    <%
                    let totalAgendamentos = 0;
                    let totalHorariosLivres = 0;
                    let diasComAgendamento = 0;

                    if (typeof days !== 'undefined' && days) {
                        days.forEach(d => {
                            const key = d.format('YYYY-MM-DD');
                            const agendados = (typeof resultsByDay !== 'undefined' && resultsByDay[key]) ? resultsByDay[key].length : 0;
                            const livres = (typeof availableByDay !== 'undefined' && availableByDay[key]) ? availableByDay[key].length : 0;

                            totalAgendamentos += agendados;
                            totalHorariosLivres += livres;
                            if (agendados > 0) diasComAgendamento++;
                        });
                    }
                    const ocupacao = totalAgendamentos + totalHorariosLivres > 0 ? Math.round((totalAgendamentos / (totalAgendamentos + totalHorariosLivres)) * 100) : 0;
                    %>

                    <div class="space-y-3 text-sm">
                        
                        <div class="flex justify-between items-center p-2 rounded-md bg-blue-50 border border-blue-200">
                            <i class="fas fa-calendar-check text-blue-600"></i>
                            <span class="font-medium text-blue-800">Agendados:</span>
                            <span class="font-bold text-lg text-blue-800"><%= totalAgendamentos %></span>
                        </div>

                        <div class="flex justify-between items-center p-2 rounded-md bg-green-50 border border-green-200">
                            <i class="fas fa-clock text-green-600"></i>
                            <span class="font-medium text-green-800">Livres:</span>
                            <span class="font-bold text-lg text-green-800"><%= totalHorariosLivres %></span>
                        </div>

                        <div class="flex justify-between items-center p-2 rounded-md bg-purple-50 border border-purple-200">
                            <i class="fas fa-calendar-day text-purple-600"></i>
                            <span class="font-medium text-purple-800">Dias Ocup.:</span>
                            <span class="font-bold text-lg text-purple-800"><%= diasComAgendamento %></span>
                        </div>

                        <div class="flex justify-between items-center p-2 rounded-md bg-yellow-50 border border-yellow-200">
                            <i class="fas fa-percentage text-yellow-600"></i>
                            <span class="font-medium text-yellow-800">Ocupa칞칚o:</span>
                            <span class="font-bold text-lg text-yellow-800"><%= ocupacao %>%</span>
                        </div>
                    </div>
                </section>
            </div>


            <div class="lg:col-span-9 bg-white rounded-lg shadow-xl border border-gray-200 flex flex-col compact-card-container min-h-0">
                
                <div class="p-4 border-b border-gray-200 bg-gray-50 shrink-0">
                    <h2 class="text-xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-calendar-check mr-3 text-gold"></i>
                        Agenda Semanal Detalhada
                    </h2>
                </div>

                <div class="compact-card-body custom-scroll p-4 space-y-6">
                    <%
                    const weekdayMap = {
                        Monday: 'Segunda-feira', Tuesday: 'Ter칞a-feira', Wednesday: 'Quarta-feira',
                        Thursday: 'Quinta-feira', Friday: 'Sexta-feira', Saturday: 'S치bado', Sunday: 'Domingo'
                    };

                    const today = new Date(); today.setHours(0, 0, 0, 0);
                    %>

                    <% if (typeof days !== 'undefined' && days && days.length > 0 && typeof resultsByDay !== 'undefined' && typeof availableByDay !== 'undefined') { %>
                        <% days.forEach((d, index) => {
                            const key = d.format('YYYY-MM-DD');
                            const dayDate = new Date(key + 'T00:00:00'); 
                            const isToday = dayDate.toDateString() === today.toDateString();
                            const isPast = dayDate < today;

                            let badgeClass = isToday ? 'today-badge' : (isPast ? 'past-badge' : 'future-badge');
                            let dayIcon = isToday ? 'fas fa-calendar-check' : (isPast ? 'fas fa-history' : 'fas fa-calendar');

                            const agendadosList = resultsByDay[key] || [];
                            const livresList = availableByDay[key] || [];
                        %>
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                            
                            <div class="p-3 border-b border-gray-200 flex items-center justify-between bg-gray-50">
                                <div class="flex items-center space-x-3">
                                    <i class="<%= dayIcon %> text-gold"></i>
                                    <div>
                                        <h3 class="text-md font-bold text-gray-900"><%= weekdayMap[d.format('dddd')] %></h3>
                                        <p class="text-sm text-gray-600"><%= d.format('DD/MM/YYYY') %></p>
                                    </div>
                                </div>
                                <span class="weekday-badge <%= badgeClass %>">
                                    <%= agendadosList.length %> Agendado<%= agendadosList.length !== 1 ? 's' : '' %>
                                </span>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4">
                                
                                <div>
                                    <h4 class="text-sm font-semibold mb-3 text-gold flex items-center">
                                        <i class="fas fa-user-clock mr-2"></i> Agendamentos
                                    </h4>
                                    <% if (agendadosList.length > 0) { %>
                                    <div class="space-y-2 max-h-56 overflow-y-auto custom-scroll">
                                        <% agendadosList.forEach(r => { %>
                                        <div class="appointment-card p-3 rounded-md border border-l-4 <%= r.status === 'pendente' ? 'border-yellow-400 bg-yellow-50' : 'border-gray-200 bg-white' %>">
                                            <div class="flex items-center justify-between">
                                                <div class="flex-1 min-w-0">
                                                    <div class="font-semibold text-sm truncate">
                                                        <a href="/client/<%= r.clientId %>" class="text-gold hover:opacity-80 transition-colors"><%= r.clientName %></a>
                                                    </div>
                                                    <div class="text-xs text-gray-500 truncate">
                                                        <%= r.servicesNames || 'Servi칞o' %>
                                                    </div>
                                                </div>
                                                <div class="flex-shrink-0 ml-2">
                                                    <span class="bg-gold-light text-gold-dark px-2 py-0.5 rounded-full text-xs font-bold">
                                                        <%= r.timeFormatted %>
                                                    </span>
                                                </div>
                                            </div>

                                            <% if (r.status === 'pendente') { %>
                                            <div class="mt-2 pt-2 border-t border-yellow-200 flex justify-end gap-2">
                                                <form action="/admin/appointment/<%= r.id %>/confirm" method="POST">
                                                    <button type="submit" class="px-2 py-0.5 text-xs font-medium text-green-700 bg-green-100 rounded-md hover:bg-green-200 transition-colors">Confirmar</button>
                                                </form>
                                                <form action="/admin/appointment/<%= r.id %>/cancel-by-admin" method="POST" onsubmit="return promptCancelReason(this)">
                                                    <button type="submit" class="px-2 py-0.5 text-xs font-medium text-red-600 bg-red-100 rounded-md hover:bg-red-200 transition-colors">Cancelar</button>
                                                </form>
                                            </div>
                                            <% } %>
                                        </div>
                                        <% }); %>
                                    </div>
                                    <% } else { %>
                                    <p class="text-center text-gray-500 text-sm py-4 bg-gray-50 rounded-lg">Dia livre.</p>
                                    <% } %>
                                </div>

                                <div>
                                    <h4 class="text-sm font-semibold mb-3 text-green-600 flex items-center">
                                        <i class="fas fa-clock mr-2"></i> Hor치rios Livres
                                    </h4>
                                    <% if (livresList.length > 0) { %>
                                    <div class="bg-green-50 p-3 rounded-xl border border-green-200 max-h-56 overflow-y-auto custom-scroll">
                                        <div class="flex flex-wrap gap-2">
                                            <% livresList.forEach(t => { %>
                                            <span onclick="abrirModal('<%= key %>', '<%= t %>')" class="bg-green-100 text-green-800 px-3 py-1 rounded-lg text-xs font-medium hover:bg-green-200 cursor-pointer transition-all">
                                                <%= t %>
                                            </span>
                                            <% }); %>
                                        </div>
                                    </div>
                                    <% } else { %>
                                    <p class="text-center text-red-500 text-sm py-4 bg-red-50 rounded-lg">Dia completamente ocupado.</p>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                        <% }); %>
                    <% } else { %>
                        <div class="p-12 text-center bg-gray-50 rounded-lg h-full flex flex-col justify-center items-center">
                            <div class="w-16 h-16 mx-auto mb-4 bg-gray-200 rounded-full flex items-center justify-center">
                                <i class="fas fa-calendar-alt text-3xl text-gray-500"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Nenhum agendamento encontrado</h3>
                            <p class="text-gray-600 mb-4">Selecione uma data no painel  esquerda.</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <div id="modalAgendamento" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
            <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-2xl border border-gray-300 animate-fade-in-up">
                <h2 class="text-lg font-bold mb-4 text-gray-800 flex items-center"><i class="fas fa-calendar-plus mr-2 text-gold"></i> Agendar Hor치rio</h2>
                <form action="/appointment" method="POST">
                    <input type="hidden" id="modalDate" name="date">
                    <input type="hidden" id="modalTime" name="time">

                    <div class="mb-4">
                        <label for="clientSearch" class="block text-sm font-medium text-gray-700">Cliente:</label>
                        <input type="text" id="clientSearch" class="w-full p-2 border border-gray-300 bg-gray-50 rounded focus:ring-1 focus:ring-gold" placeholder="Digite o nome do cliente..." autocomplete="off" required>
                        <input type="hidden" name="clientId" id="clientId">
                        <ul id="clientSuggestions" class="absolute border border-gray-300 rounded mt-1 bg-white max-h-40 overflow-y-auto w-full z-10 hidden"></ul>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">Servi칞o/Produto:</label>
                        <input type="text" id="serviceName" class="w-full p-2 border border-gray-300 bg-gray-50 rounded mb-2 focus:ring-1 focus:ring-gold" placeholder="Nome do servi칞o" required>
                        <input type="number" id="servicePrice" class="w-full p-2 border border-gray-300 bg-gray-50 rounded mb-2 focus:ring-1 focus:ring-gold" placeholder="Pre칞o (R$)" required step="0.01">
                        <input type="number" id="serviceDuration" class="w-full p-2 border border-gray-300 bg-gray-50 rounded focus:ring-1 focus:ring-gold" placeholder="Dura칞칚o (min)" required>
                        <input type="hidden" name="services" id="servicesInput">
                        <input type="hidden" name="duration" id="durationInput">
                    </div>
                    
                    <div class="mb-4">
                         <label class="block text-sm font-medium text-gray-700" for="staffId">Profissional:</label>
                         <select id="staffId" name="staffId" class="w-full p-2 border border-gray-300 bg-gray-50 rounded focus:ring-1 focus:ring-gold" required>
                             <option value="">Selecione o Profissional</option>
                             <% if (typeof staffList !== 'undefined') { %>
                                 <% staffList.forEach(staff => { %>
                                     <option value="<%= staff.id %>"><%= staff.name %></option>
                                 <% }); %>
                             <% } %>
                         </select>
                    </div>

                    <div class="flex justify-end gap-4 mt-6">
                        <button type="button" onclick="fecharModal()" class="text-gray-500 hover:text-gray-700">Cancelar</button>
                        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">Agendar</button>
                    </div>
                </form>
            </div>
        </div>
        </main>

    <div id="toast-success" class="fixed top-5 right-5 z-50 hidden bg-green-100 border border-green-400 text-green-800 px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3">
        <i class="fas fa-check-circle text-green-600"></i>
        <span id="toast-message" class="font-semibold"></span>
    </div>
    <footer class="bg-white border-t border-gray-200 shrink-0">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="text-center text-gray-600 text-sm">
                <p class="flex items-center justify-center">
                    <i class="fas fa-crown mr-2 text-gold"></i>
                    AgendaPro 춸 <%= new Date().getFullYear() %>
                </p>
            </div>
        </div>
    </footer>

    <% if (typeof clients !== 'undefined' && clients) { %>
      <div id="clients-data" class="hidden" data-clients='<%- JSON.stringify(clients) %>'></div>
    <% } else { %>
      <div id="clients-data" class="hidden" data-clients='[]'></div>
    <% } %>

    <% if (typeof pendingAppointments !== 'undefined' && pendingAppointments) { %>
      <div id="pending-data" class="hidden" data-pending='<%- JSON.stringify(pendingAppointments) %>'></div>
    <% } else { %>
      <div id="pending-data" class="hidden" data-pending='[]'></div>
    <% } %>

<script>
    // =================================================
    // === L칍GICA JAVASCRIPT PARA CICLO DE TEMA ===
    // =================================================

    const THEMES = ["light", "medium-dark", "deep-dark"];
    const htmlEl = document.documentElement;

    function getNextTheme(currentTheme) {
        const currentIndex = THEMES.indexOf(currentTheme);
        const nextIndex = (currentIndex + 1) % THEMES.length;
        return THEMES[nextIndex];
    }

    function updateIcons(theme) {
        const sunDesktop = document.getElementById('theme-icon-sun');
        const moonDesktop = document.getElementById('theme-icon-moon');
        const sunMobile = document.getElementById('theme-icon-sun-mobile'); 
        const moonMobile = document.getElementById('theme-icon-moon-mobile'); 
        
        const isLight = theme === 'light';

        if (sunDesktop) sunDesktop.classList.toggle('hidden', !isLight);
        if (moonDesktop) moonDesktop.classList.toggle('hidden', isLight);
        
        if (sunMobile) sunMobile.classList.toggle('hidden', !isLight);
        if (moonMobile) moonMobile.classList.toggle('hidden', isLight);
    }

    function toggleTheme() {
        const currentTheme = htmlEl.getAttribute('data-theme') || 'light';
        const newTheme = getNextTheme(currentTheme);

        htmlEl.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateIcons(newTheme);
    }

    document.addEventListener('DOMContentLoaded', function() {
         const initialTheme = htmlEl.getAttribute('data-theme') || 'light';
         updateIcons(initialTheme);
         
         const toggleButtonDesktop = document.getElementById('theme-toggle-btn');
         const toggleButtonMobile = document.getElementById('theme-toggle-btn-mobile'); 

         if (toggleButtonDesktop) {
             toggleButtonDesktop.addEventListener('click', toggleTheme);
         }
         if (toggleButtonMobile) { 
             toggleButtonMobile.addEventListener('click', toggleTheme);
         }
    });
    // FIM DA L칍GICA DE TEMA ============================

    // Toggle Menu Mobile
    const menuButton = document.getElementById('menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const closeMenu = document.getElementById('close-menu');
    if(menuButton && mobileMenu && closeMenu) {
        menuButton.addEventListener('click', () => mobileMenu.classList.remove('hidden'));
        closeMenu.addEventListener('click', () => mobileMenu.classList.add('hidden'));
    }

    // Inicializa칞칚o da Data e Alertas
    document.addEventListener('DOMContentLoaded', function () {
        const dateInput = document.getElementById('date');
        if (dateInput && !dateInput.value) {
            const defaultDate = document.querySelector('main').dataset.defaultDate;
            if (defaultDate) {
                dateInput.value = defaultDate;
            } else {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
            }
        }
        
        // ======================================================
        // ===  ALERTA DE AGENDAMENTOS PENDENTES (ATUALIZADO) ===
        // ======================================================
        const pendingDataElement = document.getElementById('pending-data');
        if (pendingDataElement) {
            try {
                const pendingList = JSON.parse(pendingDataElement.dataset.pending || '[]');
                if (pendingList.length > 0) {
                    let html = '<div style="text-align: left; max-height: 400px; overflow-y: auto; padding-right: 15px;">';
                    
                    pendingList.forEach(appt => {
                        const dateObj = new Date(appt.date);
                        const date = isNaN(dateObj.getTime())
                            ? ''
                            : dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        const time = isNaN(dateObj.getTime())
                            ? ''
                            : dateObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                            
                        const cName = appt.Client ? appt.Client.name : 'Cliente';
                        const sName = (appt.AppointmentServices && appt.AppointmentServices[0]?.name) || 
                                      (appt.AppointmentProducts && appt.AppointmentProducts[0]?.name) || 
                                      'Servi칞o';
                        const pId = appt.id; 

                        html += `
                        <div class="bg-gray-100 p-3 rounded flex flex-col gap-2 border border-gray-200" style="background-color: var(--color-bg-muted); border-color: var(--color-border);">
                            <div><strong class="text-gold-dark">${cName}</strong> <span class="text-gray-500 text-xs" style="color: var(--color-text-secondary);">(${sName})</span></div>
                            <div class="text-xs text-gray-600" style="color: var(--color-text-secondary);"><i class="far fa-clock"></i> ${date} ${time}</div>
                            <div class="flex gap-2 mt-1">
                                <form action="/admin/appointment/${pId}/confirm" method="POST" class="flex-1"><button class="w-full bg-green-100 text-green-700 py-1 rounded text-xs hover:bg-green-200 font-bold" style="background-color: rgba(52, 211, 153, 0.2); color: #16a34a;">Confirmar</button></form>
                                <form action="/admin/appointment/${pId}/cancel-by-admin" method="POST" class="flex-1" onsubmit="return promptCancelReason(this)"><button class="w-full bg-red-100 text-red-700 py-1 rounded text-xs hover:bg-red-200 font-bold" style="background-color: rgba(254, 202, 202, 0.2); color: #dc2626;">Cancelar</button></form>
                            </div>
                        </div>`;
                    });
                    html += '</div>';
                    
                    Swal.fire({
                        title: `<span class="text-lg" style="color: var(--color-text-primary);">游댒 ${pendingList.length} Pendente(s)</span>`,
                        html: html,
                        showConfirmButton: false,
                        showCloseButton: true,
                        width: '400px',
                        background: 'var(--color-bg-secondary)',
                        color: 'var(--color-text-primary)',
                    });
                }
            } catch(e) { console.error(e); }
        }
    });

    // Fun칞칚o para pedir o motivo do cancelamento
    function promptCancelReason(form) {
        const reason = prompt("Por favor, insira o motivo do cancelamento:");
        if (reason === null || reason.trim() === "") {
            alert("O motivo do cancelamento 칠 obrigat칩rio.");
            return false;
        }
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'cancellationReason';
        input.value = reason.trim();
        form.appendChild(input);
        return true;
    }

    // L칩gica do Modal de Agendamento
    const modal = document.getElementById('modalAgendamento');
    const clientSearch = document.getElementById('clientSearch');
    const clientSuggestions = document.getElementById('clientSuggestions');
    const clientIdInput = document.getElementById('clientId');
    let clients = [];
    try {
        const raw = document.getElementById('clients-data').dataset.clients;
        clients = JSON.parse(raw);
    } catch(e) { console.error("Erro ao carregar clientes:", e); }

    function abrirModal(date, time) {
        document.getElementById('modalDate').value = date;
        document.getElementById('modalTime').value = time;
        modal.classList.remove('hidden');
    }

    function fecharModal() {
        modal.classList.add('hidden');
        clientSuggestions.classList.add('hidden');
        clientSearch.value = '';
        clientIdInput.value = '';
        document.getElementById('serviceName').value = '';
        document.getElementById('servicePrice').value = '';
        document.getElementById('serviceDuration').value = '';
    }

    // Pesquisa de Clientes
    clientSearch.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        clientSuggestions.innerHTML = '';
        if (query.length < 2) {
            clientSuggestions.classList.add('hidden');
            return;
        }

        const filteredClients = clients.filter(client => 
            client.name.toLowerCase().includes(query) || 
            (client.phone && client.phone.includes(query))
        );

        if (filteredClients.length > 0) {
            clientSuggestions.style.width = clientSearch.offsetWidth + 'px'; 
            filteredClients.forEach(client => {
                const li = document.createElement('li');
                li.className = 'p-2 cursor-pointer hover:bg-gray-100 text-gray-800 text-sm';
                li.onclick = () => {
                    clientSearch.value = client.name;
                    clientIdInput.value = client.id;
                    clientSuggestions.classList.add('hidden');
                };
                clientSuggestions.appendChild(li);
            });
            clientSuggestions.classList.remove('hidden');
        } else {
            clientSuggestions.classList.add('hidden');
        }
    });

    // Submiss칚o do formul치rio de agendamento (junta dados do servi칞o)
    document.querySelector('#modalAgendamento form').addEventListener('submit', function(e) {
        const clientIdHidden = document.getElementById('clientId');
        const clientSearchInput = document.getElementById('clientSearch');
        if (!clientIdHidden || !clientSearchInput) return;

        const clientId = clientIdHidden.value;
        const clientName = clientSearchInput.value;

        // Verifica se o cliente foi selecionado corretamente
        const clientExists = Array.isArray(clients) ? clients.find(c => c && c.id === clientId && c.name === clientName) : null;
        if (!clientId || !clientExists) {
            e.preventDefault();
            Swal.fire({
                icon: 'error',
                title: 'Cliente Inv치lido',
                text: 'Por favor, digite o nome e SELECIONE um cliente da lista antes de agendar.',
                confirmButtonColor: '#ef4444',
                background: 'var(--color-bg-secondary)'
            });
            clientSearchInput.focus();
            return false;
        }


        const serviceName = document.getElementById('serviceName').value;
        const servicePrice = document.getElementById('servicePrice').value;
        const serviceDuration = document.getElementById('serviceDuration').value;

        const serviceData = [{
            name: serviceName,
            price: parseFloat(servicePrice),
            duration: parseInt(serviceDuration)
        }];

        document.getElementById('servicesInput').value = JSON.stringify(serviceData);
        document.getElementById('durationInput').value = serviceDuration;

    });
</script>
</body>
</html>