<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Minha Área – <%= orgName %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --color-gold-light: #FFD700;
            --color-gold-dark: #B8860B;
            --color-gold-accent: #DAA520;
        }
        .text-gold { color: var(--color-gold-dark); }
        .bg-gold { background-color: var(--color-gold-accent); }
        .border-gold { border-color: var(--color-gold-light); }
        .ring-gold-dark { --tw-ring-color: var(--color-gold-dark); }

        /* Cores de Status Refinadas */
        .status-tag {
            padding: 0.25rem 0.75rem; /* py-1 px-3 */
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* font-semibold */
            border-radius: 9999px; /* rounded-full */
            border-width: 1px;
            display: inline-flex;
            align-items: center;
            white-space: nowrap; /* Evita quebra de linha */
        }
        .status-pendente {
            background-color: #FFFBEB; color: #B45309; border-color: #FDE68A; /* Amarelo */
        }
        .status-confirmado {
            background-color: #F0FDF4; color: #15803D; border-color: #BBF7D0; /* Verde */
        }
        .status-concluido {
            background-color: #F9FAFB; color: #4B5563; border-color: #E5E7EB; /* Cinza */
        }
        .status-cancelado {
            background-color: #FEF2F2; color: #B91C1C; border-color: #FECACA; /* Vermelho */
        }
        .status-tag i {
            margin-right: 0.375rem; /* mr-1.5 */
        }

    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <header class="bg-white shadow-md sticky top-0 z-10">
        <nav class="container mx-auto max-w-4xl px-4 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-gray-800"><%= orgName %></h1>
                <p class="text-sm text-gray-600">Olá, <span class="font-semibold"><%= clientName %></span>!</p>
            </div>
            <a href="/portal/logout"
               class="text-sm text-gray-600 hover:text-gold-dark transition-colors"
               title="Sair">
                <i class="fas fa-sign-out-alt fa-lg"></i>
            </a>
        </nav>
    </header>

    <main class="container mx-auto max-w-4xl p-4 space-y-8 mt-4 mb-8">

        <% if (error) { %>
            <div class="p-4 bg-red-50 border border-red-200 rounded-xl">
                <p class="text-sm text-red-800 font-medium"><i class="fas fa-exclamation-triangle mr-2"></i><%= error %></p>
            </div>
        <% } %>
        <% if (success) { %>
            <div class="p-4 bg-green-50 border border-green-200 rounded-xl">
                <p class="text-sm text-green-800 font-medium"><i class="fas fa-check-circle mr-2"></i><%= success %></p>
            </div>
        <% } %>

        <a href="/portal/agendar"
           class="block w-full bg-gold text-white text-center py-4 px-6 rounded-xl font-bold text-lg hover:opacity-90 transition-all shadow-lg">
            <i class="fas fa-calendar-plus mr-3"></i>
            <span>Novo Agendamento</span>
        </a>

        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="p-5 border-b border-gray-200 flex items-center space-x-3">
                <i class="fas fa-calendar-check text-xl text-gold-dark"></i>
                <h2 class="text-xl font-bold text-gray-800">Próximos Agendamentos</h2>
            </div>

            <% if (proximosAgendamentos.length === 0) { %>
                <p class="p-6 text-gray-600 text-center">Você não tem nenhum agendamento futuro.</p>
            <% } else { %>
                <ul class="divide-y divide-gray-200">
                    <% proximosAgendamentos.forEach(appt => { %>
                        <li class="p-5 flex flex-col sm:flex-row justify-between sm:items-center space-y-3 sm:space-y-0">
                            <div class="space-y-1.5">
                                <div class="flex items-center space-x-3 flex-wrap gap-y-2">
                                    <span class="status-tag
                                        <% if (appt.status === 'pendente') { %> status-pendente <% } %>
                                        <% if (appt.status === 'confirmado') { %> status-confirmado <% } %>
                                    ">
                                        <i class="fas <%= appt.status === 'pendente' ? 'fa-clock' : 'fa-check-circle' %>"></i>
                                        <%= appt.status === 'pendente' ? 'Pendente' : 'Confirmado' %>
                                    </span>
                                    <h3 class="text-base font-semibold text-gray-900"><%= appt.date %> às <%= appt.time %></h3>
                                </div>
                                <p class="text-sm text-gray-700 pl-1"><%= appt.services %></p>
                                <p class="text-xs text-gray-500 pl-1">Com: <span class="font-medium"><%= appt.staffName %></span></p>
                            </div>
                             <% if (appt.status === 'pendente' || appt.status === 'confirmado') { %>
                                <%# Botão Cancelar (Ação Futura) %>
                                <%# Adicionar form aqui se implementar cancelamento %>
                             <% } %>
                        </li>
                    <% }); %>
                </ul>
            <% } %>
        </div>

        <% if (produtosPendentes.length > 0) { %>
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="p-5 border-b border-gray-200 flex items-center space-x-3">
                     <i class="fas fa-shopping-bag text-xl text-gold-dark"></i>
                    <h2 class="text-xl font-bold text-gray-800">Produtos Pendentes</h2>
                </div>
                 <p class="text-xs text-gray-500 px-5 pt-3 pb-1">Itens adicionados pelo salão com pagamento pendente.</p>
                <ul class="divide-y divide-gray-200">
                    <% produtosPendentes.forEach(prod => { %>
                        <li class="p-5 flex justify-between items-start">
                            <div class="space-y-1">
                                <h3 class="text-base font-semibold text-gray-900"><%= prod.name %></h3>
                                <p class="text-sm text-gray-600">Valor Total: R$ <%= prod.price.toFixed(2).replace('.', ',') %></p>
                                <p class="text-xs text-red-600 font-medium">Falta Pagar: R$ <%= (prod.price - prod.totalPaid).toFixed(2).replace('.', ',') %></p>
                                <p class="text-xs text-gray-500">Adicionado em: <%= prod.addedAt %></p>
                            </div>
                            <span class="status-tag status-pendente mt-1">
                                <i class="fas fa-dollar-sign"></i> Pendente
                            </span>
                        </li>
                    <% }); %>
                </ul>
            </div>
        <% } %>

        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
             <div class="p-5 border-b border-gray-200 flex items-center space-x-3">
                 <i class="fas fa-history text-xl text-gold-dark"></i>
                <h2 class="text-xl font-bold text-gray-800">Histórico de Agendamentos</h2>
            </div>

            <% if (historicoAgendamentos.length === 0) { %>
                <p class="p-6 text-gray-600 text-center">Você ainda não possui histórico de agendamentos.</p>
            <% } else { %>
                <ul class="divide-y divide-gray-200">
                    <% historicoAgendamentos.forEach(appt => { %>
                        <li class="p-5">
                            <div class="flex items-center space-x-3 mb-1.5 flex-wrap gap-y-2">
                                <span class="status-tag
                                    <% if (appt.status.startsWith('cancelado')) { %> status-cancelado <% } else { %> status-concluido <% } %>
                                ">
                                    <i class="fas <%= appt.status.startsWith('cancelado') ? 'fa-times-circle' : 'fa-check-double' %>"></i>
                                    <%
                                        let statusText = appt.status.charAt(0).toUpperCase() + appt.status.slice(1);
                                        if (statusText === 'Cancelado_pelo_cliente') statusText = 'Cancelado por você';
                                        if (statusText === 'Cancelado_pelo_salao') statusText = 'Cancelado pelo salão';
                                    %>
                                    <%= statusText %>
                                </span>
                                <h3 class="text-base font-semibold text-gray-900"><%= appt.date %> às <%= appt.time %></h3>
                            </div>
                            <p class="text-sm text-gray-700 ml-1"><%= appt.services %></p>
                            <% if (appt.staffName !== 'Qualquer Profissional') { %>
                            <p class="text-xs text-gray-500 ml-1">Com: <span class="font-medium"><%= appt.staffName %></span></p>
                            <% } %>

                            <!-- ================================= -->
                            <!-- ===     NOVA ALTERAÇÃO AQUI     === -->
                            <!-- ================================= -->
                            <% if (appt.status === 'cancelado_pelo_salao' && appt.cancellationReason) { %>
                                <div class="mt-2 ml-1 p-3 bg-red-50 border border-red-200 rounded-lg">
                                    <p class="text-xs text-red-800 font-medium">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Motivo do cancelamento: <%= appt.cancellationReason %>
                                    </p>
                                </div>
                            <% } %>
                            <!-- ================================= -->

                        </li>
                    <% }); %>
                </ul>
            <% } %>
        </div>

        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="p-5 border-b border-gray-200 flex items-center space-x-3">
                <i class="fas fa-archive text-xl text-gold-dark"></i>
               <h2 class="text-xl font-bold text-gray-800">Histórico de Produtos</h2>
           </div>
            <p class="text-xs text-gray-500 px-5 pt-3 pb-1">Itens que você já adquiriu e que estão totalmente pagos.</p>
           
           <% if (historicoProdutos.length === 0) { %>
               <p class="p-6 text-gray-600 text-center">Você ainda não possui histórico de produtos pagos.</p>
           <% } else { %>
               <ul class="divide-y divide-gray-200">
                   <% historicoProdutos.forEach(prod => { %>
                       <li class="p-5 flex justify-between items-start">
                           <div class="space-y-1">
                               <h3 class="text-base font-semibold text-gray-900"><%= prod.name %></h3>
                               <p class="text-sm text-gray-600">Valor Total: R$ <%= prod.price.toFixed(2).replace('.', ',') %></p>
                               <p class="text-xs text-gray-500">Adicionado em: <%= prod.addedAt %></p>
                           </div>
                           <span class="status-tag status-concluido mt-1">
                               <i class="fas fa-check-double"></i> Pago
                           </span>
                       </li>
                   <% }); %>
               </ul>
           <% } %>
       </div>

    </main>

    <footer class="text-center py-8 mt-4">
        <p class="text-sm text-gray-600">
            <i class="fas fa-crown mr-1.5 text-gold"></i>
            <%= orgName %> © <%= new Date().getFullYear() %>
        </p>
    </footer>

</body>
</html>
